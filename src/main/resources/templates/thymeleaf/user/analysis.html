<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  layout:decorate="~{thymeleaf/layouts/user_layout}">
<head>
<meta charset="UTF-8">
<title>Insert title here</title>

<script type="text/javascript" src="http://code.jquery.com/jquery-latest.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<script type="text/javascript">
//나의 정보조회
// function myInfo(){
	$(function(){
		
		$.ajax({
			url:"/user/patternChk",
			method:"get",
			async:"false",
			dataType:"json",
			success:function(data){
				console.log(data);
				if(data.result=='Y'){
					$("#patternChk").trigger('click');
					$("#patternChk").prop("disabled",true);
					$("#patternChk").css("background-color","#4169E1");
					$("#patternChk").val("분석 완료");
					
				}	
				
			},
			error:function(e){
				console.log(e);
			}
		})
		
})
	function swapImage() {
      var image = document.getElementById('myImage');
      if (image.src.includes('question_mark.png')) {
        image.src = '/assets/card.png';
      } else {
    	  
    	image.onclick = null;      
//         image.src = '/assets/question.png';
      }
    }
	function myPattern(){
		
	
		$.ajax({
			url:"/user/oob_token",
			method:"post",
			dataType:"json",
			async:"false",
			success:function(data){
				if(data==false){
					console.log('이미등록 oob있음');
				}else{
					console.log('새로운 oob등록완료');
				}
			},
			error:function(e){
				alert("oob등록실패");
			}
		})
		

		$.ajax({
			url:"/user/info_balance",
			method:'get',
			dataType:'json',
			success:function(data){
				var response=data;
				console.log(response);
// 				var res_list=data['res_list'];
// 				console.log(res_list);
				var balance_list=response.map(row=>Number(row.balance_amt));
				console.log(balance_list);
				var balance_sum=balance_list.reduce((accumulator, current) => accumulator + current, 0);
				console.log(balance_sum);
				
				$("#list").empty();//화면 초기화
				$("#list").append(
						'<br/><div class="charts-wrapper">'+ 
						'<h2 class="title">자산</h2>'+
						'<p>총자산</p>'+
						'<h2>'+balance_sum+'원</h2>'	+
						'</div>'
				);
//	 				급여계좌
//	     		83764585969076959 [국민은행]
				for(var i=0;i<response.length;i++){
					$("#list").append(
						
						'<div class="box container" >'+
	            		'		<p>'+response[i].bank_name+'</p>'+
	            		'<h3>'+response[i].balance_amt+'원</h3>'+
	            		'</div>'
	            		
					)                         
				}                      
			},
			error:function(xhr, status, error){
//	 			location.reload();//페이지 새로고침
				console.log(xhr.responseText);
//	 				alert("통신실패");
			}
		});
		
		$.ajax({
			url:"/user/pattern",
			method:"get",
			async:"false",
			dataType:"json",
			success:function(data){
				$("#list2").append(
						'<br/><div class="charts-wrapper">'+ 
						'<br/><h2 class="title">소비·수입</h2>'+
	                	'<div class="charts-container1">'+
		         			'<canvas id="chart1" width= 400px;></canvas>'+
		         		'</div>'+
		         		'<div class="charts-container">'+
		         			'<canvas id="chart3"></canvas>'+
	         			'</div>'+
	         			'<div class="charts-container">'+
	         			'<canvas id="chart4"></canvas>'+
	         			'</div>'+
	         			'<br/><h2 class="title">예측</h2>'+
	         			'<div class="charts-container3">'+
	         			'<canvas id="chart5"></canvas>'+
	         			'<p id="exp"></p><br/>'+
	         			'</div>'+
	         			'<br/><br/><h2 class="title">추천카드</h2>'+
	         			'<div style="text-align:center;" id="card1">'+
	            		'<a><img id="myImage" src="/assets/question_mark.png" onclick="swapImage()" alt="Question Mark"></a> '+
	            		'<div>'+
		            		'<div>'+
			            		'</br><h3 id="percent_plus_minus"></h3>'+
			            		'<h3 id="five_percent"></h3>'+
			            	'</div>'+
			            	'<div>'+
			            		'<button id="joinbtn" class="btn">카드발급</button>'+
			            	'</div>'+
		            	'</div>'+
	            		'</div>'+
	      			'</div>'
				);
				console.log(data.categoryCommand);
				var size=data.categoryCommand.length;
				//전체소비
				var total_cs=[];
				var total_plus=[];
				var per_month=[];
				for(var i=0;i<size;i++){
					per_month.push(i+1+"월");
					total_cs.push(data.categoryCommand[i].total);	
					total_plus.push(data.categoryCommand[i].plus);
				}
				console.log("전체수입리스트"+total_plus);
				console.log("전체소비리스트"+total_cs);
				//전체수입합
				var sum_total_plus=total_plus.reduce((accumulator, current) => accumulator + current, 0);
				var sum_total_minus=total_cs.reduce((accumulator, current) => accumulator + current, 0);
				console.log(sum_total_plus);
				console.log(sum_total_minus);
				var percent_plus_minus=Math.round(sum_total_minus/sum_total_plus*100);
				$("#percent_plus_minus").text("현재 당신의 수입에 대한 소비는"+percent_plus_minus+"%입니다.");
				
				var five_percent=Math.round(sum_total_plus*5/100);
				$("#five_percent").text('이카드를 사용할 경우 전달 대비'+five_percent+'원을 줄일수있습니다.');
                //전체소비합
				createChart2('chart1',per_month,total_plus,total_cs,'전체 소비·수입');
				
				//카테고리별 소비(전체,5월)
				var category_key=Object.keys(data.categoryCommand[0]);
				category_key.pop();
				category_key.pop();
// 				console.log(category_key);
				var category_latest=Object.values(data.categoryCommand[4]);
				category_latest.pop();
				category_latest.pop();
// 				console.log(category_latest);
				
				createChart1('chart4',category_key,category_latest,'이번달 카테고리별 소비');
				var category_total=[];
// 				for(var i=0;i<8;i++){
// 					console.log(category_key[i]);
// 				}
				for(var i=0;i<8;i++){
					var ck=category_key[i];
					
					var category_sum=data.categoryCommand.map(row=>row[ck]);
					category_total.push(category_sum.reduce((accumulator, current) => 
                          accumulator + current, 0));
				}
				console.log(category_total);
				createChart1('chart3',category_key,category_total,'전체 카테고리별 소비');
				
				console.log(total_cs);
				
				//이번달 예측 소비
				const avg = total_cs.reduce((accumulator, current, index, array) => {
				    if(index == array.length-1) {
				        return (accumulator + current) / array.length;
				    }
				    return accumulator + current;
				}, 0);
				console.log(avg);
				var exp_cs=per_month;
				exp_cs.push("이번달")
				total_cs.push(avg);
				
				createChart('chart5',exp_cs,total_cs,'이번달 예상 소비 금액');
				$("#exp").text('이번달 예상 지출액은'+avg+'원 입니다');
				
				
				var joinBtnOffset = $('#joinbtn').offset().top;
				$('html, body').animate({ scrollTop: joinBtnOffset }, 500, function() {
				  // Scroll animation completed
				// Show loading indicator and apply blur effect
				
				// Slowly scroll to the bottom
			    $('html, body').animate({ scrollTop: $(document).height() }, 500);
				});
			
			},
			error:function(error){
				console.log(error);
			}
		})
		
		
}
	function createChart2(chartId,h_data,in_v_data,ex_v_data,name) {
		  var ctx = document.getElementById(chartId).getContext('2d');
		  var backgroundColors = ['rgba(0, 207, 255, 0.2)', 'rgba(255, 99, 132, 0.2)'];
		  var borderColors = ['rgba(0, 207, 255, 1)', 'rgba(255, 99, 132, 1)'];

		  var myChart = new Chart(ctx, {
			    type: 'bar',
			    data: {
			      labels: h_data,
			      datasets: [{
			        label: '수입',
			        data: in_v_data,
			        backgroundColor: backgroundColors[0],
			        borderColor: borderColors[0],
			        borderWidth: 1,
			        barPercentage: 1.0, // Adjust the bar width as desired
			        categoryPercentage:0.7,
			        barSpacing: '10px'
			      },
			      {
			        label: '소비',
			        data: ex_v_data,
			        backgroundColor: backgroundColors[1],
			        borderColor: borderColors[1],
			        borderWidth: 1,
			        barPercentage: 1.0, // Adjust the bar width as desired
			        categoryPercentage: 0.7,
			        barSpacing: '10px'
			      }]
			    },
			    options: {
			      responsive: true,
			      maintainAspectRatio: false,
			      scales: {
			        y: {
			          beginAtZero: true
			        }
			      }
			    }
			  });		
		}
	function createChart(chartId, h_data, v_data, name) {
		  var ctx = document.getElementById(chartId).getContext('2d');
		  var backgroundColors = v_data.map((_, index) => index === v_data.length - 1 && chartId === 'chart5' ? 'rgba(0, 207, 255, 0.8)' : 'rgba(0, 207, 255, 0.2)');
		  var borderColors = v_data.map((_, index) => index === v_data.length - 1 && chartId === 'chart5' ? 'rgba(0, 207, 255, 1)' : 'rgba(0, 207, 255, 1)');

		  var myChart = new Chart(ctx, {
		    type: 'bar',
		    data: {
		      labels: h_data,
		      datasets: [{
		        label: name,
		        data: v_data,
		        backgroundColor: backgroundColors,
		        borderColor: borderColors,
		        borderWidth: 1,
		        barPercentage: 1.0,
		        categoryPercentage: 1.0,
		        barSpacing: '10px'
		      }]
		    },
		    options: {
		      responsive: true,
		      maintainAspectRatio: false,
		      scales: {
		        y: {
		          beginAtZero: true
		        }
		      }
		    }
		  });
		}
	function createChart1(chartId, h_data, v_data, name) {
		  var ctx = document.getElementById(chartId).getContext('2d');
		  var total = v_data.reduce((acc, value) => acc + value, 0);
		  var percentages = v_data.map(value => ((value / total) * 100).toFixed(2) + '%');

		  var myChart = new Chart(ctx, {
		    type: 'bar',
		    data: {
		      labels: h_data,
		      datasets: [{
		        label: name,
		        data: v_data,
		        backgroundColor: ['rgba(0, 207, 255, 0.8)','rgba(255, 99, 132, 0.8)',
		        	'rgba(255, 159, 64, 0.8)','rgba(255, 205, 86, 0.8)',
		        	'rgba(75, 192, 192, 0.8)','rgba(54, 162, 235, 0.8)',
		        	'rgba(153, 102, 255, 0.8)','rgba(255, 0, 0, 0.8)'],
		      }]
		    },
		    options: {
		      indexAxis: 'y',
		      responsive: true,
		      maintainAspectRatio: false,
		      scales: {
		        y: {
		          beginAtZero: true,
		          ticks: {
		            callback: function(value, index, values) {
		              return value.toLocaleString();
		            }
		          }
		        },
		        x: {
		          beginAtZero: true,
		          ticks: {
		            callback: function(value, index, values) {
		              return value.toLocaleString();
		            }
		          }
		        }
		      },
		      plugins: {
		        tooltip: {
		          callbacks: {
		            label: function(context) {
		              var value = context.dataset.data[context.dataIndex];
		              var percentage = percentages[context.dataIndex];
		              return 'Value: ' + value.toLocaleString() + ', Percentage: ' + percentage;
		            }
		          }
		        }
		      }
		    }

		  });
		// Create the table container
// 		  var tableContainer = document.createElement('div');
// 		  tableContainer.classList.add('table-container');

// 		  // Create the table rows
// 		  var tableRows = h_data.map((category, index) => {
			  
// 			var row = document.createElement('div');
// 		    var row1 = document.createElement('div');
// 		    row1.classList.add('table-row');
// 		    var row2 = document.createElement('div');
// 		    row2.classList.add('table-row');
// 		    var categoryCell = document.createElement('h4');
// 		    categoryCell.textContent = category;
// 		    var percentageCell = document.createElement('p');
// 		    percentageCell.textContent =percentages[index];
// 		    var amountCell = document.createElement('p');
// 		    amountCell.textContent =  v_data[index].toLocaleString();

// 		    row1.appendChild(categoryCell);
// 		    row1.appendChild(percentageCell);
// 		    row2.appendChild(amountCell);
		    
// 		    row.appendChild(row1);
// 		    row.appendChild(row2);

// 		    return row;
// 		  });

// 		  // Append the table rows to the table container
// 		  tableRows.forEach(function (row) {
// 		    tableContainer.appendChild(row);
// 		  });

// 		  var chartContainer = document.getElementById(chartId);

// 		  chartContainer.insertAdjacentElement('afterend', tableContainer);

		}
</script>

<style type="text/css">
	.title {
      border-bottom: 8px solid #4682B4;
    }
	input[type="button"]{
		text-align:center;
		margin-top:10px;
		margin-bottom:10px;
	}
	.charts-wrapper {
	text-align:center;
	  overflow-x: auto;
	  max-width: 100%;
	}
	.charts-container {
	max-width: 100%;
	width: 600px;
 	 height: 450px;
	  display: flex;
	}
	
	.charts-container1 {
		
		max-width: 100%;
		height: 600px;
		width:800px;
	}
	.charts-container3 {
		max-width: 100%;
		width:800px;
		height: 600px;
		
	}
	#chart5,#exp{
		flex:1;
	}
	
	#chart1 {

	  flex: 1;
	  margin-right: 10px; /* Adjust the margin as needed */
	}
	
	#chart3, #chart4 {

	  flex: 1;
	  margin-right: 10px; /* Adjust the margin as needed */
	}
	
	#joinbtn{
		background-color: #000099;
		color: white;
		border-radius: 10px;
		width:200px;
		height:80px;
	}
	
	img{
		border: 1px solid  #000099;
		border-radius: 10px;
		width:400px;
		height:250px;
	}
	
	
</style>
</head>


<body>
<div layout:fragment="content">
<h1>소비패턴분석</h1>


 <main class="mb-4">
        <div class="container px-4 px-lg-5">
            <div class="row gx-4 gx-lg-5 justify-content-center">
                <div class="col-md-10 col-lg-8 col-xl-6">
                	
                    <p>소비패턴이 궁금하지 않으신가요?</p>
                    <p>클릭 하시면 소비,분석,비교,예측,카드 추천해 드립니다.</p>
					<p>참여하고 무료 기프티콘 받아가세요!!</p>
					
                </div>
                
                <input style="border-radius: 10px;background-color: #000099; width:300px;" type="button" id="patternChk" class="btn btn-dark" value="소비패턴분석하기" onclick="myPattern()" />
            	
<!--             	<div class="card-list"> -->		
<!--             	</div> -->
            	
            	
            	
            	<div id="list"></div>
            	<div id="list2"></div>
            </div>
            
            
        </div>
    </main>
</div>
</body>
</html>