<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  layout:decorate="~{thymeleaf/layouts/user_layout}">
<head>
<meta charset="UTF-8">
<title>Insert title here</title>

<script type="text/javascript" src="http://code.jquery.com/jquery-latest.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<script src="/js/analysis.js"></script>
<link href="/css/analysis.css" rel="stylesheet" />
<script type="text/javascript">
//나의 정보조회
// function myInfo(){
	$(function(){

		$.ajax({
			url:"/user/patternChk",
			method:"get",
			async:"false",
			dataType:"json",
			success:function(data){
				console.log(data);
				if(data.result=='Y'){
					$("#patternChk").trigger('click');
					$("#patternChk").prop("disabled",true);
					$("#patternChk").css("border","#4169E1");
					$("#patternChk").css("background-color","#4169E1");
					$("#patternChk").val("분석 완료");
					
				}	
				
			},
			error:function(e){
				console.log(e);
			}
		})
		
		$.ajax({
			url:"/user/joinChk",
			method:"get",
			async:"false",
			dataType:"json",
			success:function(data){
				console.log(data);
				if(data.result=='Y'){
					$("#joinbtn").prop("disabled",true);
					$("#joinbtn").css("border","#4169E1");
					$("#joinbtn").css("background-color","#4169E1");
					$("#joinbtn").val("참여완료");
					
				}	
				
			},
			error:function(e){
				console.log(e);
			}
		})
		
})
	function swapImage() {
      var image = document.getElementById('myImage');
      if (image.src.includes('question_mark.png')) {
        image.src = '/assets/card.png';
      } else {
    	  
    	image.onclick = null;      

      }
    }
	function myPattern(){
		
		$.ajax({
			url:"/user/oob_token",
			method:"post",
			dataType:"json",
			async:"false",
			success:function(data){
				if(data==false){
					console.log('이미등록 oob있음');
				}else{
					console.log('새로운 oob등록완료');
				}
			},
			error:function(e){
				alert("oob등록실패");
			}
		})
		

		$.ajax({
			url:"/user/info_balance",
			method:'get',
			async:"false",
			dataType:'json',
			success:function(data){
				var response=data;
				console.log(response);
// 				var res_list=data['res_list'];
// 				console.log(res_list);
				var balance_list=response.map(row=>Number(row.balance_amt));
				console.log(balance_list);
				var balance_sum=balance_list.reduce((accumulator, current) => accumulator + current, 0);
				console.log(balance_sum);
				
				$("#list").empty();//화면 초기화
				$("#list").append(
						'<br/><div class="charts-wrapper">'+ 
						'<h2 class="title">자산</h2>'+
						'<p>총자산</p>'+
						'<h2>'+balance_sum+'원</h2>'	+
						'</div>'
				);
//	 				급여계좌
//	     		83764585969076959 [국민은행]
				for(var i=0;i<response.length;i++){
					$("#list").append(
						
						'<div class="box container" >'+
	            		'		<p>'+response[i].bank_name+'</p>'+
	            		'<h3>'+response[i].balance_amt+'원</h3>'+
	            		'</div>'
	            		
					)                         
				}                      
			},
			error:function(xhr, status, error){
//	 			location.reload();//페이지 새로고침
				console.log(xhr.responseText);
//	 				alert("통신실패");
			}
		});
		
		$.ajax({
			url:"/user/pattern",
			method:"get",
			async:"false",
			dataType:"json",
			success:function(data){
				$("#list2").append(
						'<br/><div class="charts-wrapper" >'+ 
						'<br/><h2 class="title">소비·수입</h2>'+
	                	'<div class="charts-container1" >'+
		         			'<canvas id="chart1" width= 400px;></canvas>'+
		         		'</div>'+
		         		'<br/><h2 class="title">카테고리별 소비</h2>'+
		         		'<div class="charts-container">'+

		         			'<canvas id="chart3"></canvas>'+

		         			'<canvas id="chart4"></canvas>'+
	         			'</div>'+
       			
	         			'<br/><h2 class="title">예측</h2>'+
	         			'<div class="charts-container">'+
	         			'<canvas id="chart6"></canvas>'+
	         			'<canvas id="chart5"></canvas>'+
	         			
	         			'</div>'+
	         			'<p th:text="${session.dto.name}"></p>'+
	         			'<p style="font-size:36px;" id="exp"></p><br/>'+
	         			'<br/><br/><h2 class="title">추천카드</h2>'+
	         			'<div style="text-align:center;" id="card1">'+
	            		'<a><img id="myImage" src="/assets/question_mark.png" onclick="swapImage()" alt="Question Mark"></a> '+
	            		'<div>'+
		            		'<div>'+
			            		'</br><h3 id="percent_plus_minus"></h3>'+
			            		'<h3 id="five_percent"></h3>'+
			            	'</div>'+
 			            	'<div>'+
 			            		'<button id="up_btn" class="btn" onclick="scroll_up()">올라가서 카드발급</button>'+
			            	'</div>'+
		            	'</div>'+
	            		'</div>'+
	      			'</div>'
				);
				console.log(data.categoryCommand);
				var size=data.categoryCommand.length;
				//전체소비
				var total_cs=[];
				var total_plus=[];
				var per_month=[];
				for(var i=0;i<size;i++){
					per_month.push(i+1+"월");
					total_cs.push(data.categoryCommand[i].total);	
					total_plus.push(data.categoryCommand[i].plus);
				}
				console.log("전체수입리스트"+total_plus);
				console.log("전체소비리스트"+total_cs);
				//전체수입합
				var sum_total_plus=total_plus.reduce((accumulator, current) => accumulator + current, 0);
				var sum_total_minus=total_cs.reduce((accumulator, current) => accumulator + current, 0);
				console.log(sum_total_plus);
				console.log(sum_total_minus);
				var percent_plus_minus=Math.round(sum_total_minus/sum_total_plus*100);
				$("#percent_plus_minus").text("현재 당신의 수입에 대한 소비는"+percent_plus_minus+"%입니다.");
				
				var five_percent=Math.round(sum_total_plus*5/100);
				$("#five_percent").text('이 카드를 사용할 경우 전달 대비'+five_percent+'원(5%)을 줄일수있습니다.');
                //전체소비합
				createChart2('chart1',per_month,total_plus,total_cs,'전체 소비·수입');
				
				//카테고리별 소비(전체,5월)
				var category_key=Object.keys(data.categoryCommand[0]);
				category_key.pop();
				category_key.pop();
				
				var category_latest=Object.values(data.categoryCommand[4]);
				category_latest.pop();
				category_latest.pop();
				//정렬
				category_latest.sort(function(a,b){
					return b-a;
				})
				
				createChart1('chart4',category_key,category_latest,'이번달 카테고리별 소비');
				var category_total=[];

				for(var i=0;i<8;i++){
					var ck=category_key[i];
					
					var category_sum=data.categoryCommand.map(row=>row[ck]);
					category_total.push(category_sum.reduce((accumulator, current) => 
                          accumulator + current, 0));
				}
				//정렬
				category_total.sort(function(a,b){
					return b-a;
				})
				console.log(category_total);
				createChart1('chart3',category_key,category_total,'전체 카테고리별 소비');
				
				console.log(total_cs);
				//연령별 평균 소비
				var age_avg=['20-29','30-39','40-49','50-59'];
				var min_cs=[127,230,268,223];
				var avg_cs=[136,246,286,244];
				createChart3('chart6',age_avg,min_cs,avg_cs,'연령별 최소·평균 소비');
				//이번달 예측 소비
				const avg = total_cs.reduce((accumulator, current, index, array) => {
				    if(index == array.length-1) {
				        return (accumulator + current) / array.length;
				    }
				    return accumulator + current;
				}, 0);
				console.log(avg);
				var exp_cs=per_month;
				exp_cs.push("이번달")
				total_cs.push(avg);
				
				createChart('chart5',exp_cs,total_cs,'이번달 예상 소비 금액');
				$("#exp").text('이번달 예상 지출액은'+avg+'원 입니다');
				
				
				var joinBtnOffset = $('#joinbtn').offset().top;
				$('html, body').animate({ scrollTop: joinBtnOffset }, 100, function() {
				  // Scroll animation completed
				// Show loading indicator and apply blur effect
				
				// Slowly scroll to the bottom
			    $('html, body').animate({ scrollTop: $(document).height() }, 100);
				});
			
			},
			error:function(error){
				console.log(error);
			}
		})
		
		
}
	
	function card_token(){

		var url="https://testapi.openbanking.or.kr/oauth/2.0/authorize?"
			+"response_type=code&"//고정값 : 인증요청시 반환되는 값의 타입
			+"client_id=4987e938-f84b-4e23-b0a2-3b15b00f4ffd&"//이용기관 ID
			+"redirect_uri=http://localhost:8070/user/card_token&"//응답 URI
			+"scope=login cardinfo&"//토큰의 권한
			+"state=12345678123456781234567812345678&"//32자리 난수 설정
			+"auth_type=0";//0: 최초한번인즈, 2: 인증 생략

	window.open(url,"인증하기","width:400px;height60px;");

	}
	function scroll_up(){
		console.log("스크롤올리기");
		$('html,body').animate({scrollTop:0},'fast');
	}
</script>

<style type="text/css">

</style>
</head>


<body>
<div layout:fragment="content">



 <main class="mb-4">
        <div class="container px-4 px-lg-5">
        <h2 class="title">소비패턴분석</h2>
            <div class="row gx-4 gx-lg-5 justify-content-center">
                <div class="col-md-10 col-lg-8 col-xl-6">
                	<div id=pattern_content>
                		
                		<p>소비패턴이 궁금하지 않으신가요?</p>
	                    <p>클릭 하시면 소비,분석,비교,예측,카드 추천해 드립니다.</p>
						<p>참여하고 무료 기프티콘 받아가세요!!</p>
                	</div>
                    
					
                </div>
                <div class="pattern_join_btn">
                	
                	<input style="border-radius: 10px;background-color: #000099; width:300px;" type="button" id="patternChk" class="btn btn-dark" value="소비패턴분석하기" onclick="myPattern()" />
                	<input style="border-radius: 10px;background-color: #000099; width:300px;" type="button" id="joinbtn" class="btn btn-dark" value="카드발급하고 참여하기" onclick="card_token()" />
            	
                </div>
                
<!--             	<div class="card-list"> -->		
<!--             	</div> -->
            	
            	
            	
            	
            	<div id="list"></div>
            	<div id="list2"></div>
            </div>
            
            
        </div>
    </main>
</div>
</body>
</html>